<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Pixel Challenge</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>

<body>
  <h1>My Pixel Challenge</h1>
  <div id="container" class="container">

    <div id="gameboard" class="gameboard">
      <canvas id="canvas" class="game" width="550" height="550"></canvas>
      <div id="chat" class="chat">

      </div>
      <div class="msg-input">
        <input type="text" name="message" id="message" placeholder="type a message...">
        <input type="button" value="send" id="send">
      </div>
    </div>
  </div>

  <script>
    // ---- @initialization ----     
    var imgUrl;

    const width = 550;
    const height = 550;

    var socket = io.connect();
    socket.on('client_connect', function (data) {

    });
    // --- @functions ---
    var sendMessage = function (msg) {
      socket.emit('message', { message: msg });
    };

    var chat = function (data) {

      let c = getRandomColor();
      let username = "<span style=" + "color:" + c + ">" + data.username + ': </span>';
      let child = username + '<span class="msg">' + data.message + '</span>' + '</br>';
      jQuery("#chat").append(child);
    };

    var getRandomColor = function () {
      let letters = '0123456789ABCDEF';
      let color = '#';
      for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    };
    // ---- @events trigger ----
    jQuery("#send").on('click', function () {
      sendMessage(jQuery('#message').val());
      jQuery('#message').val('')
    });

    jQuery('#message').on('change', function () {
      sendMessage(jQuery(this).val());
      jQuery(this).val('')

    });

    // ---- @Canvas ----

    var canvas = jQuery('#canvas');
    canvas.css('background-image', 'url(' + imgUrl + ')');

    ctx = canvas[0].getContext("2d");

    socket.on('init', function (data) {
      canvas.css('background-image', 'url(' + data.imgUrl + ')');

      //var squareW = Math.floor(width / data.width);
      //var squareY = Math.floor(height / data.height);

      var pixelWidth = width / data.width;
      var pixelHeight = height / data.height;

      var margeWidth = 0;
      var margeHeight = 0;

      ctx.beginPath();

      for(var i = 1; i <= data.height; i++) {
        for(var y = 1; y <= data.width; y++) {
          console.log(`pos x = ${margeWidth}, pos y = ${margeHeight}, width: ${pixelWidth}, height: ${pixelHeight}`)
          addPixel(margeWidth, margeHeight, pixelWidth, pixelHeight);
          margeWidth += pixelWidth;
        }
        margeWidth = 0;
        margeHeight += pixelHeight;
      }

      ctx.closePath();


      /**ctx.beginPath();
  
      for (var i = 0; i < width; i += squareW) {
        addPixel(0, 0, squareW, squareW);
        addPixel(0, squareW, squareW, squareW);
        addPixel(squareW, 0, squareW, squareW);
        addPixel(squareW, squareW, squareW, squareW)
      }

      ctx.closePath();
      ctx.beginPath();

      for (var i = 0; i < height; i += squareY) {
        addPixel(0, 0, squareY, squareY);
        addPixel(0, squareY, squareY, squareY);
        addPixel(squareY, 0, squareY, squareY);
        addPixel(squareY, squareY, squareY, squareY)
      }

      ctx.closePath();
      */
    });

    function addPixel(x, y , width, height) {
      ctx.fillStyle = getRandomColor();
      ctx.fillRect(x, y, width, height);
    }

    socket.on('message', function (data) {
      chat(data);
    });

  </script>
</body>

</html>